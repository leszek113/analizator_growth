{% extends "base.html" %}

{% block title %}Dashboard - Analizator Rynku{% endblock %}

{% block content %}
<style>
    .flag-container {
        text-align: center;
        padding: 5px;
        border-radius: 5px;
        transition: background-color 0.2s;
    }
    
    .flag-container:hover {
        background-color: rgba(0,0,0,0.1);
    }
    
    .flag-emoji {
        font-size: 1.2rem;
        cursor: pointer;
    }
    
    .flag-emoji:hover {
        transform: scale(1.2);
        transition: transform 0.2s;
    }
    
    .flag-select {
        font-size: 16px !important;
        line-height: 1.2 !important;
    }
    
    .flag-select option {
        font-size: 16px !important;
        line-height: 1.2 !important;
    }
</style>

<div class="row">
    <!-- Statystyki -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üìä Statystyki</h5>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6">
                        <h3 class="text-primary">{{ stats.total_runs }}</h3>
                        <small class="text-muted">Uruchomie≈Ñ</small>
                    </div>
                    <div class="col-6">
                        <h3 class="text-success">{{ stats.latest_companies_count }}</h3>
                        <small class="text-muted">Sp√≥≈Çek (ostatnio)</small>
                    </div>
                </div>
                <hr>
                <div class="text-center">
                    <small class="text-muted">
                        Ostatnie uruchomienie:<br>
                        <strong>{{ stats.latest_run_date }}</strong>
                    </small>
                    <hr>
                    <div class="mt-2">
                        {% if stats.has_today_run %}
                            <span class="badge bg-success">‚úÖ Dzisiejsza selekcja wykonana</span>
                            {% if stats.today_run_info %}
                                <br>                        <small class="text-muted">
                            {{ stats.today_run_info.selected_count }} sp√≥≈Çek w selekcji (Etap 1)
                        </small>
                            {% endif %}
                        {% else %}
                            <span class="badge bg-warning">‚ö†Ô∏è Brak dzisiejszej selekcji</span>
                        {% endif %}
                    </div>
                    <hr>
                    <div class="mt-2">
                        <small class="text-info">
                            <strong>{{ app_name }}</strong><br>
                            Wersja {{ full_version }}
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Najnowsze wyniki -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">üéØ Najnowsze wyniki selekcji (Etap 1)</h5>
                <a href="{{ url_for('results') }}" class="btn btn-sm btn-outline-primary">Zobacz wszystkie</a>
            </div>
            <div class="card-body">
                {% if latest_results is defined and latest_results is not none and latest_results.stage1_companies is defined and not latest_results.stage1_companies.empty %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Flaga</th>
                                    <th>Ticker</th>
                                    <th>Nazwa</th>
                                    <th>Sektor</th>
                                    <th>Stochastic 1M</th>
                                    <th>Stochastic 1W</th>
                                    <th>Stochastic OK</th>
                                    <th>Notatki</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for company in latest_results.stage1_companies.head(10).to_dict('records') %}
                                <tr>
                                    <td>
                                        <div class="flag-container">
                                            <span class="flag-display" 
                                                  onclick="showFlagModal('{{ company.ticker }}', '{{ company.flag_color }}', '{{ company.flag_notes }}')"
                                                  {% if company.flag_notes %}data-bs-toggle="tooltip" data-bs-placement="top" title="{{ company.flag_notes }}"{% endif %}
                                                  style="cursor: pointer; font-size: 1.5rem;">
                                                {% if company.flag_color == 'none' %}‚ö™
                                                {% elif company.flag_color == 'red' %}üî¥
                                                {% elif company.flag_color == 'green' %}üü¢
                                                {% elif company.flag_color == 'yellow' %}üü°
                                                {% elif company.flag_color == 'blue' %}üîµ
                                                {% else %}‚ö™{% endif %}
                                            </span>
                                        </div>
                                    </td>
                                    <td>
                                        <a href="{{ url_for('company_history', ticker=company.ticker) }}">
                                            <strong>{{ company.ticker }}</strong>
                                        </a>
                                    </td>
                                    <td>{{ company.informational_data_parsed.get('company', 'N/A') }}</td>
                                    <td>{{ company.informational_data_parsed.get('sector', 'N/A') }}</td>
                                    <td>
                                        {% if company.stochastic_1m %}
                                            <span class="badge {% if company.stochastic_1m < 30 %}bg-success{% else %}bg-warning{% endif %}">
                                                {{ "%.1f"|format(company.stochastic_1m) }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if company.stochastic_1w %}
                                            <span class="badge {% if company.stochastic_1w < 30 %}bg-success{% else %}bg-warning{% endif %}">
                                                {{ "%.1f"|format(company.stochastic_1w) }}%
                                            </span>
                                        {% else %}
                                            <span class="text-muted">N/A</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if company.stage2_passed %}
                                            <span class="badge bg-success">‚úÖ</span>
                                        {% else %}
                                            <span class="badge bg-warning">‚ö†Ô∏è</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="notes-badge" onclick="showNotes('{{ company.ticker }}')" style="cursor: pointer;">
                                            N-{{ "%02d"|format(company.notes_count) }}
                                        </span>
                                        <button class="btn btn-sm btn-outline-primary ms-1" onclick="addNote('{{ company.ticker }}')" title="Dodaj notatkƒô">
                                            <i class="bi bi-plus"></i>
                                        </button>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% if latest_results.stage1_companies|length > 10 %}
                        <div class="text-center mt-2">
                            <small class="text-muted">
                                Pokazano 10 z {{ latest_results.stage1_companies|length }} sp√≥≈Çek
                            </small>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="text-center text-muted">
                        <p>Brak wynik√≥w do wy≈õwietlenia</p>
                        <button class="btn btn-primary" onclick="runAnalysis()">
                            Uruchom pierwszƒÖ analizƒô
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Historia uruchomie≈Ñ -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">üìà Historia uruchomie≈Ñ</h5>
            </div>
            <div class="card-body">
                {% if history is defined and history is not none and not history.empty %}
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                                                <th>Liczba sp√≥≈Çek</th>
                            <th>Status</th>
                            <th>Notatki</th>
                                    <th>Wersja selekcji</th>
                                    <th>Wersja info</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for _, run in history.iterrows() %}
                                <tr>
                                    <td>{{ run.run_date }}</td>
                                                                    <td>{{ run.selected_count }}</td>
                                <td>{{ run.status }}</td>
                                <td>{{ run.notes }}</td>
                                    <td><span class="badge bg-info">{{ run.selection_rules_version }}</span></td>
                                    <td><span class="badge bg-secondary">{{ run.informational_columns_version }}</span></td>
                                    <td>
                                        <span class="badge bg-success">{{ run.status }}</span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted">
                        <p>Brak historii uruchomie≈Ñ</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
    // ===== FUNKCJE DLA FLAG =====
    
    function changeFlag(ticker, newFlag) {
        const flagNames = {
            'none': 'Brak flagi',
            'red': 'Czerwona',
            'green': 'Zielona', 
            'yellow': '≈ª√≥≈Çta',
            'blue': 'Niebieska'
        };
        
        // Poka≈º modal z notatkƒÖ je≈õli flaga nie jest 'none'
        if (newFlag !== 'none') {
            const notes = prompt(`Dodaj notatkƒô do flagi ${flagNames[newFlag]} (max 40 znak√≥w):`);
            if (notes === null) {
                // Anulowano - przywr√≥ƒá poprzedniƒÖ warto≈õƒá
                const select = event.target;
                select.value = select.getAttribute('data-previous-value') || 'none';
                return;
            }
            
            setFlag(ticker, newFlag, notes);
        } else {
            setFlag(ticker, newFlag, '');
        }
        
        // Zapisz aktualnƒÖ warto≈õƒá jako poprzedniƒÖ
        event.target.setAttribute('data-previous-value', newFlag);
    }
    
    function setFlag(ticker, flagColor, flagNotes) {
        fetch(`/api/flags/${ticker}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                flag_color: flagColor, 
                flag_notes: flagNotes 
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Flaga zosta≈Ça ustawiona');
                setTimeout(() => location.reload(), 1000);
            } else {
                alert('B≈ÇƒÖd: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('B≈ÇƒÖd podczas ustawiania flagi');
        });
    }
    
    // Inicjalizacja tooltip√≥w
    document.addEventListener('DOMContentLoaded', function() {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    });
    
    // Funkcja do pokazywania modala flagi
    function showFlagModal(ticker, currentFlag, currentNotes) {
        const flagNames = {
            'none': 'Brak flagi',
            'red': 'Czerwona',
            'green': 'Zielona', 
            'yellow': '≈ª√≥≈Çta',
            'blue': 'Niebieska'
        };
        
        const flagEmojis = {
            'none': '‚ö™',
            'red': 'üî¥',
            'green': 'üü¢',
            'yellow': 'üü°',
            'blue': 'üîµ'
        };
        
        let modalHtml = `
            <div class="modal fade" id="flagModal" tabindex="-1">
                <div class="modal-dialog modal-sm">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Flaga dla ${ticker}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <div class="mb-3">
                                <label class="form-label">Wybierz kolor flagi:</label>
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-outline-secondary flag-btn" data-flag="none" style="font-size: 1.5rem; width: 50px; height: 50px;">‚ö™</button>
                                    <button class="btn btn-outline-secondary flag-btn" data-flag="red" style="font-size: 1.5rem; width: 50px; height: 50px;">üî¥</button>
                                    <button class="btn btn-outline-secondary flag-btn" data-flag="green" style="font-size: 1.5rem; width: 50px; height: 50px;">üü¢</button>
                                    <button class="btn btn-outline-secondary flag-btn" data-flag="yellow" style="font-size: 1.5rem; width: 50px; height: 50px;">üü°</button>
                                    <button class="btn btn-outline-secondary flag-btn" data-flag="blue" style="font-size: 1.5rem; width: 50px; height: 50px;">üîµ</button>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="flagNotes" class="form-label">Notatka (max 40 znak√≥w):</label>
                                <input type="text" class="form-control" id="flagNotes" maxlength="40" value="${currentNotes || ''}" placeholder="Opcjonalna notatka">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Anuluj</button>
                            <button type="button" class="btn btn-primary" onclick="saveFlag('${ticker}')">Zapisz</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        // Usu≈Ñ istniejƒÖcy modal je≈õli istnieje
        const existingModal = document.getElementById('flagModal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // Dodaj nowy modal
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Poka≈º modal
        const modal = new bootstrap.Modal(document.getElementById('flagModal'));
        modal.show();
        
        // Zaznacz aktualnƒÖ flagƒô
        const currentBtn = document.querySelector(`[data-flag="${currentFlag}"]`);
        if (currentBtn) {
            currentBtn.classList.remove('btn-outline-secondary');
            currentBtn.classList.add('btn-primary');
        }
        
        // Obs≈Çuga klikniƒôƒá na flagi
        document.querySelectorAll('.flag-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                // Usu≈Ñ zaznaczenie ze wszystkich
                document.querySelectorAll('.flag-btn').forEach(b => {
                    b.classList.remove('btn-primary');
                    b.classList.add('btn-outline-secondary');
                });
                // Zaznacz klikniƒôtƒÖ
                this.classList.remove('btn-outline-secondary');
                this.classList.add('btn-primary');
            });
        });
    }
    
    // Funkcja do zapisywania flagi
    function saveFlag(ticker) {
        const selectedFlag = document.querySelector('.flag-btn.btn-primary').dataset.flag;
        const notes = document.getElementById('flagNotes').value;
        
        setFlag(ticker, selectedFlag, notes);
        
        // Zamknij modal
        bootstrap.Modal.getInstance(document.getElementById('flagModal')).hide();
    }
</script>
{% endblock %} 